<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DJ Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      padding: 2rem;
    }
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    input[type="search"] {
      padding: 0.5rem;
      width: 200px;
    }
    select,
    button {
      padding: 0.5rem;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      cursor: pointer;
    }
    .card {
      padding: 1rem;
      background: #222;
      border-left: 4px solid #0f0;
      margin-bottom: 0.5rem;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      position: relative;
    }
    .card.new {
      opacity: 1;
      transform: none;
      animation: flash 1s;
    }
    @keyframes flash {
      from {
        background: #444;
      }
      to {
        background: #222;
      }
    }
    .fulfilled {
      opacity: 0.6;
      border-left-color: #888;
    }
    .timestamp {
      font-size: 0.8rem;
      color: #aaa;
    }
    .count {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: #0f0;
      color: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .checkbox {
      position: absolute;
      top: 1rem;
      right: 1rem;
      transform: scale(1.3);
    }
  </style>
</head>
<body>
  <h1>Live Song Requests</h1>
  <div class="controls">
    <input type="search" id="searchInput" placeholder="Search artist or title" />
    <select id="sortSelect">
      <option value="timestamp">Latest</option>
      <option value="count">Most Requested</option>
    </select>
    <button id="exportBtn">Export CSV</button>
  </div>
  <div id="feed"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
      authDomain: "song-request-a8a68.firebaseapp.com",
      projectId: "song-request-a8a68",
      storageBucket: "song-request-a8a68.appspot.com",
      messagingSenderId: "522633732679",
      appId: "1:522633732679:web:564894980a2e0484828762",
      measurementId: "G-H6NY9N42JF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const feed = document.getElementById("feed");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const exportBtn = document.getElementById("exportBtn");

    let requestsMap = {};

    function formatTimeAgo(ts) {
      const diff = Math.floor((Date.now() - ts) / 1000);
      if (diff < 60) return diff + "s ago";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      return Math.floor(diff / 86400) + "d ago";
    }

    function renderFeed() {
      const all = Object.values(requestsMap);
      let filtered = all.filter((r) => {
        const q = searchInput.value.toLowerCase();
        return r.artist.toLowerCase().includes(q) || r.title.toLowerCase().includes(q);
      });
      filtered.sort((a, b) => {
        if (sortSelect.value === "count") return b.count - a.count;
        return b.lastRequested - a.lastRequested;
      });
      feed.innerHTML = "";
      filtered.forEach((req) => {
        const card = document.createElement("div");
        card.className = "card" + (req.fulfilled ? " fulfilled" : "");
        card.innerHTML = `
          <div class="count">${req.count}</div>
          <div class="artist">${req.artist}</div>
          <div class="title">${req.title}</div>
          <div class="timestamp">${formatTimeAgo(req.timestamp)}</div>
          <input type="checkbox" class="checkbox" ${
            req.fulfilled ? "checked" : ""
          } title="${req.fulfilled ? "Undo" : "Mark done"}">
        `;
        if (req.isNew) card.classList.add("new");
        card.querySelector(".checkbox").addEventListener("change", (e) => {
          db.collection("requests").doc(req.key).update({ fulfilled: e.target.checked });
        });
        feed.appendChild(card);
        delete req.isNew;
      });
    }

    exportBtn.addEventListener("click", () => {
      const rows = [
        ["Artist", "Title", "First Timestamp", "L]()
