<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Song Request</title>
  </head>
  <body>
    <h1>Request a Song</h1>
    <form id="requestForm">
      <input type="text" id="artist" placeholder="Artist Name" required />
      <input type="text" id="title" placeholder="Song Title" required />
      <button type="submit">Submit</button>
    </form>
    <div id="confirmation" style="display: none; color: green">
      âœ… Song request sent!
    </div>

    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
        authDomain: "song-request-a8a68.firebaseapp.com",
        projectId: "song-request-a8a68",
        storageBucket: "song-request-a8a68.appspot.com",
        messagingSenderId: "522633732679",
        appId: "1:522633732679:web:564894980a2e0484828762",
        measurementId: "G-H6NY9N42JF",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      document
        .getElementById("requestForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const artist = document.getElementById("artist").value.trim();
          const title = document.getElementById("title").value.trim();
          if (!artist || !title) return;

          const key = (artist + "||" + title).toLowerCase();
          const now = Date.now();

          const docRef = db.collection("requests").doc(key);
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            if (doc.exists) {
              tx.update(docRef, {
                count: firebase.firestore.FieldValue.increment(1),
                lastRequested: now,
              });
            } else {
              tx.set(docRef, {
                artist,
                title,
                timestamp: now,
                lastRequested: now,
                fulfilled: false,
                count: 1,
              });
            }
          });

          document.getElementById("confirmation").style.display = "block";
          setTimeout(() => {
            document.getElementById("confirmation").style.display = "none";
          }, 2000);
          e.target.reset();
        });
    </script>
  </body>
</html>
