<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Song Request</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="song-request-form.css" />
  </head>
  <body class="bg-light text-dark">
    <main class="container-fluid px-3 py-4">
      <h1 class="text-center mb-4">Request a Song</h1>
      <form id="requestForm" class="p-3">
        <div class="mb-3">
          <input
            type="text"
            class="form-control"
            id="searchInput"
            placeholder="Start typing a song..."
            autocomplete="off"
            required
          />
        </div>
        <ul id="suggestions" class="list-group mb-3"></ul>
        <img
          id="selectedArtwork"
          class="d-block mx-auto mb-3 rounded"
          style="max-width: 100px; display: none"
          class="mx-auto d-block mb-3"
          alt=""
          aria-hidden="true"
        />
        <input type="hidden" id="artist" />
        <input type="hidden" id="title" />
        <input type="hidden" id="appleMusicUrl" />
        <input type="hidden" id="artworkUrl" />

        <h5 id="requestHeading" class="mt-4 d-none">Your request</h5>
        <div
          id="selectedSongCard"
          class="card d-none mb-3 shadow-sm p-2 rounded"
        >
          <div class="d-flex align-items-start">
            <img
              id="cardArtwork"
              src=""
              alt=""
              class="rounded me-3"
              style="width: 44px; height: 44px"
            />
            <div>
              <div id="cardTitle" class="fw-semibold"></div>
              <div id="cardArtist" class="text-muted small"></div>
            </div>
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-primary w-100"
          id="submitButton"
          disabled
        >
          Submit
        </button>
      </form>
      <div id="confirmation" class="text-center mt-3 text-success fw-medium">
        âœ… Song request sent!
      </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
        authDomain: "song-request-a8a68.firebaseapp.com",
        projectId: "song-request-a8a68",
        storageBucket: "song-request-a8a68.appspot.com",
        messagingSenderId: "522633732679",
        appId: "1:522633732679:web:564894980a2e0484828762",
        measurementId: "G-H6NY9N42JF",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const searchInput = document.getElementById("searchInput");
      const suggestionsList = document.getElementById("suggestions");

      let selectedTrack = null;
      document.getElementById("selectedSongCard").classList.add("d-none");
      document.getElementById("submitButton").disabled = true;
      document.getElementById("requestHeading").classList.add("d-none");

      searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }

        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(
          query
        )}&entity=song&limit=5`;
        const response = await fetch(url);
        const data = await response.json();

        suggestionsList.innerHTML = "";
        data.results.forEach((track) => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.innerHTML = `
            <div class="d-flex align-items-start">
              <img src="${track.artworkUrl60}" class="rounded me-3" style="width:44px; height:44px;" />
              <div>
                <div class="fw-semibold">${track.trackName}</div>
                <div class="text-muted small">${track.artistName}</div>
              </div>
            </div>
          `;
          li.addEventListener("click", () => {
            document.getElementById("artist").value = track.artistName;
            document.getElementById("title").value = track.trackName;
            document.getElementById("appleMusicUrl").value = track.trackViewUrl;
            document.getElementById("artworkUrl").value = track.artworkUrl100;
            document.getElementById("selectedArtwork").src =
              track.artworkUrl100;
            document.getElementById("selectedArtwork").style.display = "block";
            suggestionsList.innerHTML = "";
            selectedTrack = track;
            document.getElementById("cardArtwork").src = track.artworkUrl100;
            document.getElementById("cardTitle").textContent = track.trackName;
            document.getElementById("cardArtist").textContent =
              track.artistName;
            document
              .getElementById("selectedSongCard")
              .classList.remove("d-none");
            document
              .getElementById("requestHeading")
              .classList.remove("d-none");
            document.getElementById("submitButton").disabled = false;
          });
          suggestionsList.appendChild(li);
        });
      });

      document
        .getElementById("requestForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const artist = document.getElementById("artist").value.trim();
          const title = document.getElementById("title").value.trim();
          const appleMusicUrl = document
            .getElementById("appleMusicUrl")
            .value.trim();
          const artworkUrl = document.getElementById("artworkUrl").value.trim();

          if (!artist || !title) return;

          const key = (artist + "||" + title).toLowerCase();
          const now = Date.now();

          const docRef = db.collection("requests").doc(key);
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            if (doc.exists) {
              tx.update(docRef, {
                count: firebase.firestore.FieldValue.increment(1),
                lastRequested: now,
              });
            } else {
              tx.set(docRef, {
                artist,
                title,
                appleMusicUrl,
                artworkUrl,
                timestamp: now,
                lastRequested: now,
                fulfilled: false,
                count: 1,
              });
            }
          });

          const confirmation = document.getElementById("confirmation");
          confirmation.style.display = "block";
          setTimeout(() => {
            confirmation.style.display = "none";
          }, 5000);
          e.target.reset();
          document.getElementById("selectedArtwork").style.display = "none";
          selectedTrack = null;
          document.getElementById("selectedSongCard").classList.add("d-none");
          document.getElementById("submitButton").disabled = true;
          document.getElementById("requestHeading").classList.add("d-none");
        });

      // Hide confirmation if user revisits page
      window.addEventListener("load", () => {
        const confirmation = document.getElementById("confirmation");
        if (confirmation) {
          confirmation.style.display = "none";
        }
      });
    </script>
  </body>
</html>
