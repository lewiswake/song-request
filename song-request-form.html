<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Song Request</title>
    <link rel="stylesheet" href="song-request-form.css" />
  </head>
  <body>
    <h1>Request a Song</h1>
    <form id="requestForm">
      <input
        type="text"
        id="searchInput"
        placeholder="Start typing a song..."
        autocomplete="off"
        required
      />
      <ul id="suggestions"></ul>

      <input type="hidden" id="artist" />
      <input type="hidden" id="title" />
      <input type="hidden" id="appleMusicUrl" />
      <input type="hidden" id="artworkUrl" />

      <button type="submit">Submit</button>
    </form>
    <div id="confirmation">✅ Song request sent!</div>

    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
        authDomain: "song-request-a8a68.firebaseapp.com",
        projectId: "song-request-a8a68",
        storageBucket: "song-request-a8a68.appspot.com",
        messagingSenderId: "522633732679",
        appId: "1:522633732679:web:564894980a2e0484828762",
        measurementId: "G-H6NY9N42JF",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const searchInput = document.getElementById("searchInput");
      const suggestionsList = document.getElementById("suggestions");

      let selectedTrack = null;

      searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }

        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(
          query
        )}&entity=song&limit=5`;
        const response = await fetch(url);
        const data = await response.json();

        suggestionsList.innerHTML = "";
        data.results.forEach((track) => {
          const li = document.createElement("li");
          li.textContent = `${track.trackName} — ${track.artistName}`;
          li.addEventListener("click", () => {
            document.getElementById("artist").value = track.artistName;
            document.getElementById("title").value = track.trackName;
            document.getElementById("appleMusicUrl").value = track.trackViewUrl;
            document.getElementById("artworkUrl").value = track.artworkUrl100;
            searchInput.value = `${track.trackName} — ${track.artistName}`;
            suggestionsList.innerHTML = "";
            selectedTrack = track;
          });
          suggestionsList.appendChild(li);
        });
      });

      document
        .getElementById("requestForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const artist = document.getElementById("artist").value.trim();
          const title = document.getElementById("title").value.trim();
          const appleMusicUrl = document
            .getElementById("appleMusicUrl")
            .value.trim();
          const artworkUrl = document.getElementById("artworkUrl").value.trim();

          if (!artist || !title) return;

          const key = (artist + "||" + title).toLowerCase();
          const now = Date.now();

          const docRef = db.collection("requests").doc(key);
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            if (doc.exists) {
              tx.update(docRef, {
                count: firebase.firestore.FieldValue.increment(1),
                lastRequested: now,
              });
            } else {
              tx.set(docRef, {
                artist,
                title,
                appleMusicUrl,
                artworkUrl,
                timestamp: now,
                lastRequested: now,
                fulfilled: false,
                count: 1,
              });
            }
          });

          const confirmation = document.getElementById("confirmation");
          confirmation.style.display = "block";
          setTimeout(() => {
            confirmation.style.display = "none";
          }, 2000);
          e.target.reset();
          selectedTrack = null;
        });
    </script>
  </body>
</html>
